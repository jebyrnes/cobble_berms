---
title: "berms_analysis"
author: "Curtis R. Morris"
date: "12/03/25"
format:
  html:
    code-fold: true
    code-summary: "Code"
---

### 0. Set-up
```{r}
## Setup/Loading Data


## load libraries
pacman::p_load(dplyr,
               tidyverse,
               readr,
               glmmTMB, # zero inflation!
               car,
               broom.mixed,
               emmeans,
               vegan,
               easystats,
               knitr,
               kableExtra,
               broom,
               lubridate,
               performance
               )
## Helpers
theme_set(theme_classic(base_size = 14)+
            theme(axis.text.x = 
                    element_text(angle = 40, 
                                 vjust = 1, 
                                 hjust=1),
                  legend.position = "bottom"))

berm_control_colors <- c("#af8dc3", "#7fbf7b")

fix_data_for_plots <- function(dat){
  dat |>
    # make duxbury not have a _
    mutate(site = gsub("_", " ", site)) |>
    
    # make zone a factor and order so it's low, mid, high
    mutate( height = factor(height, levels = c("Low", "Mid", "High")))
}


## load data, bind them together, and add taxonomic data
quad_s23_dat <- read_csv("../data/quads_s23.csv")
quad_f23_dat <- read_csv("../data/quads_f23.csv")
quad_s24_dat <- read_csv("../data/quads_s24.csv")
quad_s25_dat <- read_csv("../data/quads_s25.csv")
seine_dat <- read_csv("../data/seine.csv")
trap_dat <- read_csv("../data/traps.csv")
farm_dat <- read_csv("../data/farms.csv")
briv_dat <- read_csv("../data/brivs.csv")
msl <- read_csv("../data/master_sp_list.csv")

# Drop uneeded cols in msl and rename col
msl <- select(msl, 1:10) |> 
  rename(species_code = code)


```


### 1. Site-level Richness
```{r}
# bind data together, and drop the two NAs in Bayside Berm
richness_dat <- rbind(quad_s23_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(species_code)),
                      quad_f23_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(species_code)), 
                      quad_s24_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(species_code)), 
                      quad_s25_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(species_code)), 
                      seine_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(species_code)),
                      trap_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(species_code)),
                      briv_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(first_predator)),
                      briv_dat |> 
                        group_by(site, treatment) |> 
                        reframe(species_code = unique(bait_consumer))
) |> 
  filter(species_code != is.na(species_code)) |> 
  filter(species_code != "NOSP") |> 
  filter(species_code != "none_present") |> 
  filter(species_code != "UCRA")

# attach taxonomic data
richness_dat <- left_join(richness_dat, 
                          msl, 
                          "species_code")

# Remove duplicate rows
richness_dat <- unique(richness_dat)

# Filter our codes to drop
richness_dat <- richness_dat |> 
  filter(
    !(site == "Bayside" & treatment == "Berm" & species_code %in% c("UFAC", "FUCU", "UBBL", "URAL")) &
    !(site == "Bayside" & treatment == "Control" & species_code %in% c("UFAC", "UFIS", "FUCU", "UBBL", "URFI", "URBL", "UCCA")) &
    !(site == "Coughlin" & treatment == "Berm" & species_code %in% c("UNAL", "UFAC", "FUCU", "UBAL", "UBBL", "UBFI", "URCB", "UCL", "URFC", "UCCA", "UBFC")) &
    !(site == "Coughlin" & treatment == "Control" & species_code %in% c("UNAL", "UFAC", "PHSP", "UCCA")) &
    !(site == "Duxbury_Beach" & treatment == "Berm" & species_code %in% c("UFAC", "PASP", "URFC")) &
    !(site == "Duxbury_Beach" & treatment == "Control" & species_code %in% c("UFAC", "URFC"))
  )


# Identify what species are found on berms and not on controls (and v.v.)
lostspp_dat <- richness_dat |> 
  group_by(species) %>%
  filter(n_distinct(treatment) == 1) %>%
  ungroup() |> 
  select(c(site, treatment, classification_description))

# Calc richness per site_treatment
richness_dat <- richness_dat |>
  group_by(site, treatment) |>
  reframe(richness = n())

# Pivot for table
ttest_dat <- richness_dat |> 
  pivot_wider(names_from = "treatment",
              values_from = "richness") |> 
  mutate(delta = Berm-Control)


# Visualize
ggplot(richness_dat, 
                        mapping = 
         aes(x = treatment, 
             y = richness, 
             group = site,
             fill = treatment,
             shape = site)) +
  geom_line(color = "black") +
  geom_point(size = 3, 
             color = "black", 
             stroke = 1.2) +
  labs(title = "Site Level Species Richness by Treatment",
       x = "Treatment",
       y = "Species Richness") +
  scale_fill_manual(values = c("Berm" = "#af8dc3", "Control" = "#7fbf7b")) + 
  scale_shape_manual(values = c(21, 22, 24)) +
  guides(fill = "none")
```


```{r}
# Table of site level richness
ttest_dat |> 
  kable("html", caption = "Site Level Species Richness by Treatment") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")
```

Data from from all sampling methods and timepoints indicate that  site-level richness at all sites is higher in the berm treatment than in the control. Due to low sample size (n=3) these results are not statistically significant.

```{r}
# Table of species lost per site-treatments
lostspp_dat |> 
  filter(treatment == "Berm") |> 
  select(c(site, classification_description)) |> 
  kable("html", caption = "Species found only on the Berm Treatment") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")

lostspp_dat |> 
  filter(treatment == "Control") |> 
  select(c(site, classification_description)) |> 
  kable("html", caption = "Species found only on the Control Treatment") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")

```

I would say, I'm not convinced that these differences in site level richness are real. It's a small difference, and some of the lost species are highly mobile (A. rostrata and S. fuscus). Also, the site with the greatest difference (duxbury) is wide and sandy. So we're comparing communities found on a rocky cobble shore (berm) to that on a dynamic sandy ecosystem. Our protocol does not sample interstitial spp, so richness is likely underestimated on Dux control.

So I would argue against greater site-level richness on the Berms. HOWEVER, I think the bigger story here is that richness was unchanged between treatments, i.e. no negative effect of berms.

### 2. Biodiversity, Cover Composition, & Functional Groups

```{r}
# Bind together all quad data
quad_dat <- rbind(quad_s23_dat,
                  quad_f23_dat,
                  quad_s24_dat,
                  quad_s25_dat)


# Sum to the quad level
quad_dat <- quad_dat |> 
  group_by(season, site, treatment, height, quadrat, measurement_type, species_code) |> 
  reframe(sum = sum(measurement)) |> 
  filter(species_code != "NOSP") |> 
  filter(species_code != "none_present") |> 
  ungroup()

# Pull out quad richness w/o measurement_type
quad_richness <- quad_dat |> 
  group_by(season, site, treatment, height, quadrat) |> 
  reframe(richness = n_distinct(species_code))

# Pivot data for use in vegan::diversity() 
quad_dat <- quad_dat |> 
  pivot_wider(names_from = "species_code",
              values_from = "sum",
              values_fill = 0)

# Calculate Shannon, InvSimpson, richness, evenness, and rearrange
quad_dat <- quad_dat |> 
  mutate(shannon = diversity(quad_dat[,-c(1:6)], index = "shannon")) # measures the uncertainty in predicting the species identity of an individual chosen at random from the community. A higher value indicates higher diversity (more species and/or more even distribution), and a lower value indicates lower diversity. It equals 0 only when there is no uncertaintyâ€”meaning there is only ONE species present.

quad_dat <- quad_dat |> 
  mutate(invsimpson = diversity(quad_dat[,-c(1:6,85)], index = "invsimpson")) # The Inverse Simpson Index is an alternative diversity measure that focuses more on the dominance of species. The lower the value, the greater the diversity. Unlike the Shannon-Wiener index, which treats all species equally, the Inverse Simpson Index weighs more heavily on rare species, but it gives more weight to dominant species.

quad_dat <- quad_dat |> 
  mutate(richness = specnumber(quad_dat[,-c(1:6,85,86)])) # Pielous eveness how evenly individuals are distributed across the different species in a community. It ranges from 0 (completely uneven) to 1 (perfectly even).

quad_dat <- quad_dat |> 
  mutate(evenness = shannon/log(richness)) # Evenness of 0 occurs when richness is 1 (i.e. log 1 = 0, dividing by 0 = NaN)
  
quad_dat <- quad_dat |> 
select(richness, shannon, evenness, invsimpson, everything())

# Set up data for plotting
div_plot_dat <- quad_dat[,-c(11:88)] |> 
  pivot_longer(cols = richness:invsimpson, 
               values_to = "value", 
               names_to = "index")
  

```

### 5. Herbivore Abundance (LILI)
```{r}
## load the data and filter to Littorina littorea
## then sum for each quad
snail_dat <- read_csv("../data/quads_s23.csv") |>
  filter(measurement_type == "Count") |>
  filter(species_code == "LILI") |>
  group_by(site, treatment, quadrat, height) |>
  summarize(snails = sum(measurement, na.rm = TRUE)) |>
  ungroup() |> fix_data_for_plots()

## Fix up snail data to fill in 0 for quads where there
## were no snails
snail_dat <- snail_dat |>
  complete(site, treatment, nesting(quadrat, height),
           fill = list(snails = 0)) |>
  mutate(are_there_snails = as.numeric(snails !=0))


## an initial plot
ggplot(snail_dat,
       aes(x = site, color = treatment,
           y = snails)) +
  geom_point(position = position_dodge(width = 0.5),
             alpha = 0.5,
             size = 2) +
  scale_color_manual(values = berm_control_colors) +
  facet_wrap(vars(height)) +
  labs(x="", 
       y = "Littorina per\n0.25 sq m",
       color = "") 


# what's the distribution of snails?
ggplot(snail_dat,
       aes(x = snails, fill = site)) +
  geom_histogram() +
  facet_grid(rows = vars(treatment),
             cols = vars(height)) +
  labs(x = "Littorina per\n0.25 sq m")
```

Difficult to impossible to analyze statistically due to complete seperation - i.e. presence of site:treatments that are completely 0 (for example, no LILI in Bayside|Duxbury:Control for the High and Mid). But we can analyze for the low zone at Coughlin and Bayside which contain non-zero values at both treatments.

```{r}
##
# Analysis of where are there even snails
##
# snail_pres_mod <- glm(are_there_snails ~
#                         height * treatment*site,
#                       data = snail_dat,
#                       family = binomial)
# 
# Anova(snail_pres_mod) |> tidy() |>
#   mutate(p.value = round(p.value, digits = 10))

## Complete separation problem - write about things
## without stats in the text!

##
# Analysis of Low tide height
##
## an analysis using zero inflated negative binomial
## just for the low where we don't have site:treatments
## that are completely 0
snail_mod <- glmmTMB(snails ~ treatment*site,
                     zi = ~  site,
                     data = snail_dat |> filter(height == "Low"),
                     family = nbinom2)

# model diagnostics
# performance::check_model(snail_mod)


# summarizing tests
Anova(snail_mod) |> tidy()
tidy(snail_mod)

# posthoc
snail_em <- emmeans(snail_mod,
                    ~treatment | site)

snail_pairwise <- contrast(snail_em, method = "pairwise") |> 
  as.data.frame()

kable(snail_pairwise, digits = 3, caption = "LILI Abundance Contrasts by Site")
# Must ignore Dux results because there were no LILI in the low control treatment
```

Our model predicts an increase of 1.29 LILI when going from the Control to Berm in the low zone of Bayside. Duxbury cannot be determined statistically, however, this is  due to the absence of any LILI in the control. Results for Coughlin were not statistically significant.

These results align with what we see at the sites. At Bayside, the presence of the berm modifies the substrate such that the control is characterized as a small grain sand-shell hash ecosystem, and the berm has ample habitat as provisioned by the cobbles. The cobbles are also present at coughlin, however their ecological effect on provisioning habitat/ameliorating stress and thus increasing LILI abundance is decreased because the preexisting substrate is already large grain cobble in nature, so it's not modifying the preexisting substrate of the area and thus does not affect LILI abundance in a significant way. Duxbury cannot be analyzed due to the absence of LILI, but again, I would argue this is due to underlying differences in substrate among sites amd thus the impact of the berm. Duxbury is a sand ecosystem. The installation of the berm fundamentally changes this system, such that without the berm LILI simply are not present (instead Illynasa is, a soft sediment snail). 

See section 9 for an analysis of sediment differences between treatments.

# If time, include ILOB in this analysis.

### 6. Mobiles: Traps and Seine

In 2023 we assessed mobile species presence and abundance using baited crab traps, unbaited conical fish traps, and seine net tows conducted parallel to the shore.
```{r}
##
# Exploring the data
##

# Abundance of each spp per trap
abundance_dat <- trap_dat |>
    group_by(site, treatment, trap_name, trap_number, species_code) |>
    reframe(abundance = n()) |> 
  pivot_wider(names_from = species_code, values_from = abundance, values_fill = 0) |> 
  select(-NOSP)

# CAMA only
CAMA_dat <- abundance_dat |>
  select(1:5) |> 
  filter(trap_name == "Crab") |> 
  select(-trap_name)

# All spp for table
abundance_dat <- abundance_dat |>
  group_by(site, treatment, trap_name) |> 
  summarise(
    n = n_distinct(trap_number),
    across(CAMA:FUNS, ~ sum(.x, na.rm = TRUE)),
    .groups = "drop"
  )

abundance_dat |> 
  kable("html", caption = "Species abundance by site, treatment, and trap type") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")
```

Across all sites and treatments Carcinus maenus was the most abundant catch. Hemigrapsus occurred as a single individual in three traps, and all other species occurred only as a single individual. We will analyze only the abundance of CAMA as a function of treatment.

```{r}

##
# Visualize
##

# CAMA abundance by site as a function of treatment
ggplot(CAMA_dat, 
                    mapping = aes(x = treatment, 
                              y = CAMA)) +
  geom_boxplot() +
  geom_point(position = "jitter",
              alpha = .6)+
  labs(title = "CAMA abundance in traps",
       x = "Treatment",
       y = "CAMA Abundance") +
    facet_wrap(vars(site))

##
# Stats
##

# ttest for CAMA abundnace
  CAMA_ttest <- t.test(CAMA ~ treatment, data = CAMA_dat, var.equal = FALSE) |> 
    tidy()

CAMA_ttest |> 
  kable("html", caption = "T-test results for CAMA abundance by treatment") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")
  
  
# estimate estimate1 estimate2 statistic p.value parameter conf.low   conf.high 
# 1.73      6.87      5.13     0.573   0.572      24.5    -4.51      7.97
#   
```
Conclusions: no differences in CAMA abundance in a trap given a treatment. 
 
Results will now be presented for the Seine tows. 8 tows were conducted at Bayside (4 per treatment), however only 2 were conducted at Coughlin and Duxbury (1 per treatment). Data will be presented for all tows, however due to sample size only the resutls from Bayside will be analyzed.
 
```{r}
# Add date column
seine_dat <- seine_dat |> 
  mutate(date = make_date(year, month, day))

# Estimate Volume sampled
seine_dat <- seine_dat|>
  group_by(site, treatment, date) |>
  mutate(vol_sampled = ((estimated_depth_pole_1_m/estimated_depth_pole_2_m)/2)*width_net_aperture_m*distance_walked_m)

# Drop cols not interested in anymore
seine_dat <- seine_dat |> 
  select(-c(3:17,19:22))

# Reframe for abundance per m3 sampled
seine_dat <- seine_dat|>
  group_by(site, treatment, date, vol_sampled, species_code) |>
  reframe(abundance = n()) |> 
  mutate(concentration = abundance/vol_sampled)

# Make a table showing concentration by species for each tow
seine_table_dat <- seine_dat |> 
  select(-abundance) |> 
  mutate(concentration_100m3 = concentration*100) |>
  select(-concentration) |> 
  pivot_wider(names_from = species_code, 
              values_from = concentration_100m3,
              values_fill = 0) |> 
  mutate(across(where(is.numeric), ~ ifelse(.x == 0, "0", format(round(.x, 2), nsmall = 2))))

seine_table_dat |> 
  kable("html", caption = "Seine Haul Species Abundance per 100 m3", digits = 2) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")
```
As with the traps, at all sites and treatments Carcinus maenus was the most abundant catch and thus is the only species to be included in the analysis below. 

```{r}
##
# Visualize
##

# Select only bayside data, other sites have no replication
seine_bayside_dat <- seine_table_dat |> 
  filter(site == "Bayside") |> 
  ungroup()

# Make numberic
seine_bayside_dat$CAMA <- as.numeric(seine_bayside_dat$CAMA)


# CAMA abundance at bayside as a function of treatment
#seine_plot <- 
  ggplot(seine_bayside_dat, 
                    mapping = aes(x = treatment, 
                                  y = CAMA)) +
  geom_boxplot() +
  labs(title = "CAMA per 100 m3",
       x = "Treatment",
       y = "Concentration (indiv/100m3)")

##
# Stats
##

# ttest for CAMA abundnace at bayside
CAMA_seine_dat <- seine_dat |> 
  filter(species_code == "CAMA")

CAMA_seine_ttest <- t.test(data = seine_bayside_dat, 
                     CAMA ~ treatment, var.equal = FALSE) |> 
  tidy()


CAMA_seine_ttest |> 
  kable("html", caption = "T-test results for CAMA abundance in Seine tows at Bayside") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")

# estimate estimate1 estimate2 statistic p.value parameter conf.low conf.high      
# -6.92      4.06      11.0     -1.39   0.221      5.15    -19.6      5.76 

# Not significant
```

More CAMA were captured in hauls done at the control site, however results were not signficant.


### 7. Predation: BRIVS


### 8. Crypto-benthic Fish: FARMS
```{r}
# (re)load data
farm_dat <- read_csv("../data/farms.csv")

# Work it up
farm_dat <- farm_dat |> 
  mutate(date_deployed = make_date(year_deployed, month_deployed, day_deployed)) |>
  mutate(date_retrieved = make_date(year_retrieved, month_retrieved, day_retrieved)) |>
  mutate(soak_duration = date_retrieved - date_deployed) |> 
  select(-c(4:14,16:20)) |> 
  select(1,2,3,5,6,7,4) |> 
  group_by(site, treatment, farms_number, date_deployed, date_retrieved, soak_duration, species_code) |>
  reframe(abundance = n()) |> 
  pivot_wider(names_from = species_code, values_from = abundance, values_fill = 0) |> 
  filter(!is.na(date_retrieved)) |> 
  select(-c(NOSP, LESP, CRFO, ULSL, LILI)) |> # get rid of nothing placeholder, ULSL is supposed to be ULSP which is an algae, not sure why it was recorded, CRFO only recoreded on one (i.e. not consistently recorded), ditto for lesp
  mutate(soak_class = if_else(condition = soak_duration > 100, "long", "short")) |> 
  rename(FUNS = FUSP) # correcting this code. FUSP is an algae, FUNS is a fish


# Calc abundance found per farm by retrieval season/soak duration
farm_soak_dat <- farm_dat |>
  select(1,2,19, 7:18) 

farm_soak_dat <- farm_soak_dat |> 
  group_by(site, treatment, soak_class) |> 
  summarise(
    n_farms = n(),
    across(
      where(is.numeric),
      \(x) sum(x, na.rm = TRUE)), # sum up across farms
    .groups = "drop"
  ) |>
  mutate(
    across(
      -c(1:4),
      ~ round(.x / n_farms,2))) # standardize by count per farm

# Table of FARM occupancy
farm_soak_dat |> 
  kable("html", caption = "FARM occupancy by soak duration") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = FALSE) %>%
  row_spec(0, bold = TRUE, background = "#D3D3D3")
```
 FPEN, CAMA, PHGU, PAHE are the codes that occur in abundance
 FPEN most abundant in the long soak, but still present in the short soak
 PAHE only in winter/long soak, and PHGU mostly occurs in winter/long soak. This could be a factor of soak duration or seasonal displacement/migration of species.

 For this analysis, I will focus only on those spp which occur at some abundance (FPEN, CAMA, PHGU, PAHE)
 Also excluding coughlin due to not enough farms recovered

```{r}
# CAMA
CAMA_mod <- glmmTMB(CAMA ~ treatment + soak_class, 
                     data = farm_dat |> filter(site == "Bayside"), 
                     family = poisson(link = "log"))

# check_model(CAMA_mod)
# 
# summarizing tests
Anova(CAMA_mod) |> tidy() # Soak class seems to explain more than the treatment
tidy(CAMA_mod)

CAMA_plot <- ggplot(farm_dat |> filter(site == "Bayside"), 
                    mapping = aes(x = treatment, 
                                  y = CAMA,
                                  fill = treatment)) +
  geom_boxplot() +
  geom_jitter(aes(shape = soak_class),  
              width = 0.2,
              height = 0, 
              alpha = 0.6, 
              size = 2) +
  labs(title = "CAMA abundance in farms",
       x = "Treatment",
       y = "CAMA Abundance") +
  facet_wrap(vars(soak_class))
```

Soak duration explains more of CAMA abundance than treatment, however neither had a statistically significant effect.

```{r}
# FPEN
FPEN_mod <- glmmTMB(FPEN ~ treatment + soak_class, 
                    data = farm_dat |> filter(site == "Bayside"), 
                    family = poisson(link = "log"))

# check_model(FPEN_mod)
# 
# # summarizing tests
Anova(FPEN_mod) |> tidy()
tidy(FPEN_mod)
# Fewer shrimps in the control and in the short soak time. Excluded coughlin due to low soak time

ggplot(farm_dat |> filter(site == "Bayside"), 
       mapping = aes(x = treatment, 
                     y = FPEN,
                     fill = treatment)) +
  geom_boxplot() +
  geom_jitter(aes(shape = soak_class),  
              width = 0.2,
              height = 0, 
              alpha = 0.6, 
              size = 2) +
  labs(title = "FPEN abundance in farms",
       x = "Treatment",
       y = "FPEN Abundance") +
  facet_wrap(vars(soak_class))
```
Fewer shrimps in the short soak time/winter time point. Fewer shrimp in the control treatment, though this is not reflected in the winter timepoint.

```{r}
# PHGU - Bayside only
PHGU_mod <- glmmTMB(PHGU ~ treatment + soak_class, 
                    data = farm_dat |> filter(site == "Bayside"), 
                    family = poisson(link = "log"))



# check_model(PHGU_mod)
# 
# # summarizing tests
Anova(PHGU_mod) |> tidy()
tidy(PHGU_mod)
# Lose PHGU in the control and the short


ggplot(farm_dat |> filter(site == "Bayside"), 
       mapping = aes(x = treatment, 
                     y = PHGU,
                     fill = treatment)) +
  geom_boxplot() +
  geom_jitter(aes(shape = soak_class),  
              width = 0.2,
              height = 0, 
              alpha = 0.6, 
              size = 2) +
  labs(title = "PHGU abundance in farms",
       x = "Treatment",
       y = "PHGU Abundance") +
  facet_wrap(vars(soak_class))

```
Both treatment and soak class affected PHGU abundance, with the short class and the control haveing fewer individuals.  
